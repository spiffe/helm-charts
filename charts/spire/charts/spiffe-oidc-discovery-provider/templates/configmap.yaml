{{- $oidcSocket := "/run/spire/oidc-sockets/spire-oidc-server.sock" }}
{{- define "spiffe-oidc-discovery-provider.yaml-config" -}}
log_level: {{ .Values.config.logLevel | quote }}

domains:
  - "{{ include "spiffe-oidc-discovery-provider.fullname" . }}"
  - "{{ include "spiffe-oidc-discovery-provider.fullname" . }}.{{ include "spiffe-oidc-discovery-provider.namespace" . }}"
  - "{{ include "spiffe-oidc-discovery-provider.fullname" . }}.{{ include "spiffe-oidc-discovery-provider.namespace" . }}.svc.cluster.local"
  {{- if gt (len .Values.config.domains) 0 }}
  {{- .Values.config.domains | toYaml | nindent 2 }}
  {{- end }}

{{- if .Values.insecureScheme.enabled }}
allow_insecure_scheme: {{ .Values.insecureScheme.enabled }}
listen_socket_path: {{ .oidcSocket | quote }}
{{- else }}
acme:
  directory_url: {{ .Values.config.acme.directoryUrl | quote }}
  cache_dir: {{ .Values.config.acme.cacheDir | quote }}
  tos_accepted: {{ .Values.config.acme.tosAccepted }}
  email: {{ .Values.config.acme.emailAddress | quote }}
{{- end }}

workload_api:
  socket_path: {{ include "spiffe-oidc-discovery-provider.workload-api-socket-path" . | quote }}
  trust_domain: "{{ .Values.trustDomain }}"

health_checks:
  bind_port: "8008"
  ready_path: "/ready"
  live_path: "/live"
{{- end }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "spiffe-oidc-discovery-provider.fullname" . }}
  namespace: {{ include "spiffe-oidc-discovery-provider.namespace" . }}
data:
  oidc-discovery-provider.conf: |
    {{- include "spiffe-oidc-discovery-provider.yaml-config" (merge (dict) (dict "oidcSocket" $oidcSocket) .) | fromYaml | toPrettyJson | nindent 4 }}
  {{- if .Values.insecureScheme.enabled }}
  default.conf: |
    upstream oidc {
      server unix:{{ $oidcSocket }};
    }

    server {
      listen            8080;
      listen       [::]:8080;

      location / {
        proxy_pass http://oidc;
        proxy_set_header Host $host;
      }

      location /stub_status {
        allow 127.0.0.1/32;
        deny  all;
        stub_status on;
      }
    }
  {{- end }}
